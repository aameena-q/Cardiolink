<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CardioLink ECG Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #0e1628;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    /* Loading Screen */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0e1628;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(167, 180, 255, 0.2);
      border-top-color: #a7b4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loadingText {
      margin-top: 20px;
      color: #a7b4ff;
      font-size: 14px;
    }

    /* Main Content - Hidden initially */
    #mainContent {
      display: none;
      width: 100%;
      align-items: center;
      flex-direction: column;
    }

    /* Top Navigation Bar */
    .navbar {
      width: 90%;
      max-width: 1000px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .navbar-logo {
      font-size: 20px;
      font-weight: 600;
      color: #a7b4ff;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-details {
      text-align: right;
    }

    .user-name {
      color: #bcdcff;
      font-size: 14px;
      font-weight: 500;
    }

    .user-specialty {
      color: #7a8db3;
      font-size: 12px;
    }

    .btn-logout {
      background: rgba(255, 99, 99, 0.2);
      border: 1px solid rgba(255, 99, 99, 0.4);
      color: #ff6363;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255, 99, 99, 0.3);
      transform: translateY(-2px);
    }

    h1 {
      margin-bottom: 12px;
      color: #a7b4ff;
      letter-spacing: 1px;
    }

    .controls {
      width: 90%;
      max-width: 1000px;
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      align-items: center;
    }

    .controls label {
      color: #bcdcff;
      font-size: 14px;
      margin-right: 8px;
    }

    select {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      min-width: 180px;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      width: 90%;
      max-width: 1000px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.07);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .card h3 {
      margin: 0;
      font-size: 16px;
      color: #b0c4de;
      margin-bottom: 10px;
    }

    .card .value {
      font-size: 28px;
      font-weight: 600;
      color: #00ffcc;
    }

    .card .sub {
      font-size: 14px;
      color: #7fffd4;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 1000px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }

    .status {
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
      color: #9ee3ff;
    }

  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Verifying authentication...</div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="navbar-left">
        <div class="navbar-logo">ðŸ’“ CardioLink</div>
      </div>
      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-specialty" id="userSpecialty">Loading...</div>
        </div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>

    <h1>Live ECG Dashboard</h1>

    <!-- Controls: patient + session selection -->
    <div class="controls">
      <div>
        <label for="patientSelect">Patient:</label>
        <select id="patientSelect">
          <option value="">Loading patients...</option>
        </select>
      </div>

      <div>
        <label for="sessionSelect">Session (date):</label>
        <select id="sessionSelect" disabled>
          <option value="">Select a patient first</option>
        </select>
      </div>
    </div>

    <!-- Vital Stats -->
    <div class="dashboard">
      <div class="card">
        <h3>Heart Rate</h3>
        <div class="value" id="heartRate">--</div>
        <div class="sub">BPM</div>
      </div>

      <div class="card">
        <h3>Blood Pressure</h3>
        <div class="value" id="bloodPressure">--</div>
        <div class="sub">mmHg</div>
      </div>

      <div class="card">
        <h3>Oxygen Saturation</h3>
        <div class="value" id="oxygen">--</div>
        <div class="sub">%</div>
      </div>

      <div class="card">
        <h3>Temperature</h3>
        <div class="value" id="temp">--</div>
        <div class="sub">Â°C</div>
      </div>
    </div>

    <!-- ECG Chart -->
    <div class="chart-container">
      <h3 style="color:#a7b4ff;">Live ECG Trace</h3>
      <canvas id="ecgChart"></canvas>
      <p class="status" id="status">Connecting to ECG data...</p>
    </div>
  </div>

  <!-- Firebase SDK & Authentication -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onChildAdded,
      get
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0pOaxkSl03WRyuRD3JLZAVkR72Drydtw",
      authDomain: "cardiolink-1f862.firebaseapp.com",
      databaseURL: "https://cardiolink-1f862-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cardiolink-1f862",
      storageBucket: "cardiolink-1f862.firebasedatabase.app",
      messagingSenderId: "490927038737",
      appId: "1:490927038737:web:68fc2b83b62554de2cecb0",
      measurementId: "G-GNC6Z6HV2V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');
    const loadingText = document.getElementById('loadingText');
    const logoutBtn = document.getElementById('logoutBtn');

    // Check authentication status
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in
        loadingText.textContent = 'Loading dashboard...';
        
        try {
          // Get user data from database
          const userRef = ref(db, `doctors/${user.uid}`);
          const snapshot = await get(userRef);
          
          let userName = user.displayName || 'Doctor';
          let userSpecialty = 'General';
          
          if (snapshot.exists()) {
            const userData = snapshot.val();
            userName = userData.name || userName;
            userSpecialty = userData.specialty || userSpecialty;
          }
          
          // Update UI
          document.getElementById('userName').textContent = `Dr. ${userName}`;
          document.getElementById('userSpecialty').textContent = userSpecialty;
          
          // Store in localStorage for quick access
          localStorage.setItem('cardiolink_user', JSON.stringify({
            uid: user.uid,
            email: user.email,
            name: userName,
            specialty: userSpecialty
          }));
          
          // Hide loading, show content
          loadingScreen.style.display = 'none';
          mainContent.style.display = 'flex';
          
          // Initialize dashboard
          initializeDashboard();
          
        } catch (error) {
          console.error('Error loading user data:', error);
          loadingText.textContent = 'Error loading dashboard';
        }
        
      } else {
        // No user signed in, redirect to login
        loadingText.textContent = 'Not authenticated. Redirecting...';
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      }
    });

    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await signOut(auth);
          localStorage.removeItem('cardiolink_user');
          window.location.href = 'login.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Failed to logout. Please try again.');
        }
      }
    });

    // Dashboard initialization
    function initializeDashboard() {
      const patientSelect = document.getElementById('patientSelect');
      const sessionSelect = document.getElementById('sessionSelect');
      const statusEl = document.getElementById('status');
      const heartEl = document.getElementById('heartRate');
      const bpEl = document.getElementById('bloodPressure');
      const oxyEl = document.getElementById('oxygen');
      const tempEl = document.getElementById('temp');

      const ctx = document.getElementById('ecgChart').getContext('2d');
      const ecgChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'ECG Signal (mV)',
            data: [],
            borderColor: '#00ffcc',
            backgroundColor: 'rgba(0,255,204,0.05)',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { display: false },
            y: {
              color: '#fff',
              title: { display: true, text: 'mV', color: '#fff' }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });

      let currentUnsubscribe = null;

      function clearChart() {
        ecgChart.data.labels = [];
        ecgChart.data.datasets[0].data = [];
        ecgChart.update();
      }

      async function loadPatients() {
        const patientsRef = ref(db, 'patients');
        try {
          const snapshot = await get(patientsRef);
          if (!snapshot.exists()) {
            patientSelect.innerHTML = '<option value="">No patients found</option>';
            sessionSelect.innerHTML = '<option value="">No sessions</option>';
            sessionSelect.disabled = true;
            statusEl.textContent = 'No patients available in database.';
            return;
          }

          const patientsObj = snapshot.val();
          const patientIds = Object.keys(patientsObj).sort();

          patientSelect.innerHTML = '<option value="">-- Select patient --</option>';
          patientIds.forEach(pid => {
            const opt = document.createElement('option');
            opt.value = pid;
            opt.textContent = pid;
            patientSelect.appendChild(opt);
          });

          statusEl.textContent = 'Select a patient to view sessions.';
        } catch (err) {
          console.error('Failed to load patients', err);
          patientSelect.innerHTML = '<option value="">Error loading patients</option>';
          statusEl.textContent = 'Error loading patients.';
        }
      }

      async function loadSessions(patientId) {
        sessionSelect.disabled = true;
        sessionSelect.innerHTML = '<option value="">Loading sessions...</option>';
        clearChart();
        statusEl.textContent = `Loading sessions for ${patientId}...`;

        const sessionsRef = ref(db, `patients/${patientId}/sessions`);
        try {
          const snapshot = await get(sessionsRef);
          if (!snapshot.exists()) {
            sessionSelect.innerHTML = '<option value="">No sessions found</option>';
            sessionSelect.disabled = true;
            statusEl.textContent = `No sessions found for ${patientId}.`;
            return;
          }

          const sessionsObj = snapshot.val();
          const sessionDates = Object.keys(sessionsObj).sort((a,b) => b.localeCompare(a));

          sessionSelect.innerHTML = '<option value="">-- Select session (date) --</option>';
          sessionDates.forEach(dateStr => {
            const opt = document.createElement('option');
            opt.value = dateStr;
            opt.textContent = dateStr;
            sessionSelect.appendChild(opt);
          });

          sessionSelect.disabled = false;
          statusEl.textContent = `Select a session for ${patientId}.`;
        } catch (err) {
          console.error('Failed to load sessions', err);
          sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
          sessionSelect.disabled = true;
          statusEl.textContent = 'Error loading sessions.';
        }
      }

      function subscribeToECG(patientId, sessionDate) {
        if (typeof currentUnsubscribe === 'function') {
          try { currentUnsubscribe(); } catch (e) { }
          currentUnsubscribe = null;
        }

        clearChart();
        statusEl.textContent = `Connecting to ${patientId} / ${sessionDate}...`;

        const ecgRef = ref(db, `patients/${patientId}/sessions/${sessionDate}/ecg_readings`);

        currentUnsubscribe = onChildAdded(ecgRef, (snapshot) => {
          const data = snapshot.val();
          if (!data || data.value === undefined) return;

          ecgChart.data.labels.push('');
          ecgChart.data.datasets[0].data.push(data.value);
          if (ecgChart.data.labels.length > 150) {
            ecgChart.data.labels.shift();
            ecgChart.data.datasets[0].data.shift();
          }
          ecgChart.update('none');

          statusEl.textContent = `Latest: ${Number(data.value).toFixed(3)} mV`;

          heartEl.textContent = Math.floor(70 + Math.random() * 5);
          bpEl.textContent = `${120 + Math.floor(Math.random() * 5)} / 80`;
          oxyEl.textContent = (96 + Math.random() * 2).toFixed(1);
          tempEl.textContent = (36.2 + Math.random() * 0.3).toFixed(1);
        });
      }

      patientSelect.addEventListener('change', (e) => {
        const pid = e.target.value;
        if (!pid) {
          sessionSelect.innerHTML = '<option value="">Select a patient first</option>';
          sessionSelect.disabled = true;
          statusEl.textContent = 'Select a patient to view sessions.';
          if (typeof currentUnsubscribe === 'function') { try { currentUnsubscribe(); } catch(e){} currentUnsubscribe = null; }
          clearChart();
          return;
        }
        loadSessions(pid);
      });

      sessionSelect.addEventListener('change', (e) => {
        const sessionDate = e.target.value;
        const pid = patientSelect.value;
        if (!pid || !sessionDate) {
          statusEl.textContent = 'Select a patient and session.';
          if (typeof currentUnsubscribe === 'function') { try { currentUnsubscribe(); } catch(e){} currentUnsubscribe = null; }
          clearChart();
          return;
        }
        subscribeToECG(pid, sessionDate);
      });

      loadPatients();
    }
  </script>
</body>
</html>